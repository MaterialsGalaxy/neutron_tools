<tool id="constraints_gsas2" name="GSASII Refinement Constraints" profile="22.05" version="0">
    <description>Tool to upload files for neutron powder diffraction analysis in GSASII and perform an initial Rietveld refinement</description>
    <requirements></requirements>
    <command detect_errors="exit_code"><![CDATA[
        which conda &&
        conda init &&
        source ~/.bashrc &&
        conda activate GSASII &&
        mkdir app &&
        cd app/ &&
        touch $output &&
        mkdir portal &&
        ln -s $project gsas_project.gpx &&
        python $__tool_directory__/gsas2_refinement_constraints.py
                --project-filename gsas_project.gpx
                --equation-variables #for $v in $eqnConstraints # '${v.eqnVars}' #end for#
                --equation-coefficients #for $c in $eqnConstraints # '${c.eqnCoefs}' #end for#
                --equation-totals #for $t in $eqnConstraints # ${t.eqnTotal} #end for# 
                --equivalence-variables #for $v in $equivConstraints # '${v.equivVars}' #end for#
                --equivalence-coefficients #for $c in $equivConstraints # '${c.equivCoefs}' #end for#
                --output-directory /portal      
        > >(tee -a $output) 2> >(tee -a $output >&2)
    ]]></command>
    <inputs>
        <param name="project" type="data" format="Binary" label="GSASII project file"/>
        <repeat name="eqnConstraints" title="Equation Constraints">
            <param name="eqnVars" type="text" label="constraint variables list" />
            <param name="eqnCoefs" type="text" label="constraint coefficient list" />
            <param name="eqnTotal" type="float" label="equation total" />
        </repeat>

        <repeat name="equivConstraints" title="Equivalence Constraints" >
            <param name="equivVars" type="text" label="constraint variables list"/>
            <param name="equivCoefs" type="text" label="constraint coefficient list" optional="true" /> 
        </repeat>    

    </inputs>
    <outputs>
        <data format="txt" name="output" label="GSAS2 console output"></data>
        <collection type="list" name="output_collection1" label="GSAS2 refinement output">
            <discover_datasets format="binary" pattern="__designation__" directory="app/portal" visible="true"/>
        </collection>
    </outputs>
    <help>
        A tool to run a GSAS2 Rietveld refinement.
    </help>
</tool>
